```{r}
# Load CSV
df = read.csv("C:\\Users\\SREAL\\Lab Users\\mattg\\research\\projects\\world-switch-ui\\experiment\\data\\analysis\\subjective_corrected_inv.csv")

df$Interface <- as.factor(df$Interface_Choice)
df$Remembered_Choice <- as.factor(df$Remembered_Choice)
df$PID <- as.factor(df$PID)

df$Interface <- dplyr::recode(df$Interface,
    "Baseline - static menu with ray-based selection" = "Baseline",
    "Portal - head-reference with linear menu" = "Portal_Gallery",
    "Portal - Palette with hand-based selections" = "Portal_Palette_Hand",
    "Portal - Palette with head-based selections" = "Portal_Palette_Head",
    "Portal - Steering Wheel" = "Portal_WorldWheel",
    "WIM - head-referenced with linear menu" = "WIM_Gallery",
    "WIM - Palette with hand-based selections" = "WIM_Palette_Hand",
    "WIM - Palette with head-based selections" = "WIM_Palette_Head",
    "WIM Steering Wheel" = "WIM_WorldWheel"
)

demographics_df = read.csv("C:\\Users\\SREAL\\Lab Users\\mattg\\research\\projects\\world-switch-ui\\experiment\\data\\questionnaires\\demographics.csv")
demographics_df$PID = as.factor(demographics_df$ParticipantID)
demographics_df$Age = as.numeric(demographics_df$Age)
demographics_df$Sex = as.factor(demographics_df$Sex)
demographics_df$VR_Exp = as.factor(demographics_df$VR_Exp)
# print(demographics_df)
# left join demographics data 
df <- left_join(df, demographics_df, by = "PID")

# filter out PID 13
df <- df %>% filter(PID != 13)

length(unique(df$PID))

library(dplyr)
library(tibble)

# # Technique metadata (excluding TechniqueCount)
# technique_meta <- tribble(
#   ~Interface, ~Preview, ~InteractionSpace, ~PreviewSpace, ~InteractionMetaphor,
#   "WIM_SteeringWheel", "WIM", "Bimanual", "Bimanual", "SteeringWheel",
#   "WIM_Gallery", "WIM", "OneHanded", "Head", "Gallery",
#   "WIM_Palette_HeadHand", "WIM", "HeadHand", "Hand", "Palette_Head",
#   "WIM_Palette_Hand", "WIM", "Bimanual", "Hand", "Palette_Hand",
#   "Baseline", "None", "OneHanded", "World", "Baseline",
#   "Portal_SteeringWheel", "Portal", "Bimanual", "Bimanual", "SteeringWheel",
#   "Portal_Gallery", "Portal", "OneHanded", "Head", "Gallery",
#   "Portal_Palette_HeadHand", "Portal", "HeadHand", "Hand", "Palette_Head",
#   "Portal_Palette_Hand", "Portal", "Bimanual", "Hand", "Palette_Hand"
# )

# # Check that Interface column exists
# if (!"Interface" %in% names(df)) {
#   stop("The dataframe must have a column named 'Interface'")
# }

# # Identify missing techniques
# existing_choices <- unique(df$Interface)
# missing_choices <- setdiff(technique_meta$Interface, existing_choices)

# # Create new rows for missing techniques
# rows_to_add <- technique_meta %>%
#   filter(Interface %in% missing_choices)

# # Combine original and added rows
# df_extended <- bind_rows(df, rows_to_add)

# # Join metadata to all rows
# df_final <- df_extended %>%
#   left_join(technique_meta, by = "Interface")


# Convert TLX items to long format
df_long <- df %>%
  tidyr::pivot_longer(cols = starts_with("TLX"), names_to = "TLX_Item", values_to = "Score") %>%
  mutate(TLX_Item = recode(TLX_Item,
                           "TLX_1_1" = "tlx_mental",
                           "TLX_2_1" = "tlx_physical",
                           "TLX_3_1" = "tlx_temporal",
                           "TLX_4_1" = "tlx_perf",
                           "TLX_5_1" = "tlx_effort",
                           "TLX_6_1" = "tlx_frustration"))

# Create boxplots for each TLX question, grouped by Interface
tlx_everyQ = ggplot(df_long, aes(x = Interface, y = Score, fill = Interface)) +
  geom_boxplot() +
  facet_wrap(~ TLX_Item, scales = "free_y") +
  theme_minimal() +
  labs(title = "Boxplots of TLX Scores by Technique", x = "Interface Choice", y = "Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

tlx_everyQ

# Compute average TLX score
tlx_cols <- grep("^TLX_\\d+_1$", names(df), value = TRUE)
print(tlx_cols)
df$tlx_all = rowMeans(df[tlx_cols], na.rm = TRUE)
# df <- df %>%
#   mutate(TLX_All = rowMeans(select(., starts_with("TLX_")), na.rm = TRUE))

# Boxplot of overall TLX scores by interface
tlx_overall = ggplot(df, aes(x = Interface, y = tlx_all, fill = Interface)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Overall TLX Score by Interface", x = "Interface Choice", y = "Average TLX Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position  = "none")
tlx_overall

# Identify SUS columns
sus_cols <- grep("^SUS_\\d+_1$", names(df), value = TRUE)
print(sus_cols)

# Calculate SUS total score (commonly scaled to 0–100)
df$sus_score <- rowSums(df[sus_cols]) * 2.5  # 10 items * 2.5 = 100 max

# Boxplot of SUS scores across all participants
sus = ggplot(df, aes(x = Interface, y = sus_score, fill = Interface)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "SUS Scores by Interface", x = "Interface Choice", y = "SUS Score (0–100)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
sus

#####################
# UEQ

# Get all UEQ columns (assuming UEQ_1_1 to UEQ_1_8 style)
ueq_cols <- grep("^UEQ_\\d+_\\d+(\\.\\d+)?$", names(df), value = TRUE)

# Sort and split columns
ueq_first4 <- ueq_cols[1:4]
ueq_last4  <- ueq_cols[5:8]

# Compute averages
df <- df %>%
  mutate(
    UEQ_Practical = rowMeans(across(all_of(ueq_first4)), na.rm = TRUE),
    UEQ_Hedonic   = rowMeans(across(all_of(ueq_last4)), na.rm = TRUE),
    UEQ_Overall   = rowMeans(across(all_of(ueq_cols)), na.rm = TRUE)
  )

# Pivot to long format for plotting
df_ueq_long <- df %>%
  select(Interface, UEQ_Practical, UEQ_Hedonic, UEQ_Overall) %>%
  tidyr::pivot_longer(cols = starts_with("UEQ"), names_to = "UEQ_Type", values_to = "Score")

# Create box plots
ueq_all = ggplot(df_ueq_long, aes(x = Interface, y = Score, fill = Interface)) +
  geom_boxplot() +
  facet_wrap(~ UEQ_Type) +
  theme_minimal() +
  labs(title = "UEQ Scores by Interface", x = "Interface Choice", y = "Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

ueq_all

# just hedonic category of the UEQ
ueq_hedonic = ggplot(df, aes(x = Interface, y = UEQ_Hedonic, fill = Interface)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Hedonic UEQ Scores by Interface", x = "Interface Choice", y = "Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
ueq_hedonic

# get Cont columns
cont_cols <- grep("^Cont_\\d+_1$", names(df), value = TRUE)
df$cont_avg = rowMeans(df[cont_cols], na.rm = TRUE)

df_subjective = df

```


```{r}
library(dplyr)
library(emmeans)
library(ARTool)
library(rstatix)
library(effectsize)

# Load data
data <- df_subjective

# Ensure columns are set right
data$ParticipantID <- as.factor(data$ParticipantID)
data$Interface <- as.factor(data$Interface)

# UEQ HEDONIC

# Print average hedonic score and 95% CI for each interface
data %>%
    group_by(Interface) %>%
    summarise(
        mean_hedonic = mean(UEQ_Hedonic, na.rm = TRUE),
        sd_hedonic = sd(UEQ_Hedonic, na.rm = TRUE),
        n = n(),
        se = sd_hedonic / sqrt(n),
        ci_lower = mean_hedonic - qt(0.975, df = n - 1) * se,
        ci_upper = mean_hedonic + qt(0.975, df = n - 1) * se
    ) %>%
    print()


# Run ART model
m.art.avg <- art(UEQ_Hedonic ~ Interface + Error(ParticipantID), data = data)

# ANOVA
anova_results <- anova(m.art.avg)
print(anova_results)

# Effect sizes (partial eta squared)
eta_squared_results <- eta_squared(anova_results, partial = TRUE)
print(format(eta_squared_results, digits=4))

# Contrasts
art.con(m.art.avg, ~ Interface, adjust = "bonferroni")
```


Continuity
```{r}
#CONTINUITY

# Print average continuity score and 95% CI for each interface
data %>%
    group_by(Interface) %>%
    summarise(
        mean_cont = mean(cont_avg, na.rm = TRUE),
        sd_cont = sd(cont_avg, na.rm = TRUE),
        n = n(),
        se = sd_cont / sqrt(n),
        ci_lower = mean_cont - qt(0.975, df = n - 1) * se,
        ci_upper = mean_cont + qt(0.975, df = n - 1) * se
    ) %>%
    print()

# Run ART model
m.art.avg <- art(cont_avg ~ Interface + Error(ParticipantID), data = data)

# ANOVA
anova_results <- anova(m.art.avg)
print(anova_results)

# Effect sizes (partial eta squared)
eta_squared_results <- eta_squared(anova_results, partial = TRUE)
print(format(eta_squared_results, digits=4))

# Contrasts
art.con(m.art.avg, ~ Interface, adjust = "bonferroni")
```

NASA TLX
```{r}
# NASA TLX
# Ensure columns are set right
data$ParticipantID <- as.factor(data$ParticipantID)
data$Interface <- as.factor(data$Interface)

data %>%
    group_by(Interface) %>%
    summarise(
        mean_tlx = mean(tlx_all, na.rm = TRUE),
        sd_tlx = sd(tlx_all, na.rm = TRUE),
        n = n(),
        se = sd_tlx / sqrt(n),
        ci_lower = mean_tlx - qt(0.975, df = n - 1) * se,
        ci_upper = mean_tlx + qt(0.975, df = n - 1) * se
    ) %>%
    print()

# Run ART model
m.art.avg <- art(tlx_all ~ Interface + Error(ParticipantID), data = data)

# ANOVA
anova_results <- anova(m.art.avg)
print(anova_results)

# Effect sizes (partial eta squared)
eta_squared_results <- eta_squared(anova_results, partial = TRUE)
print(format(eta_squared_results, digits=4))

# Contrasts
art.con(m.art.avg, ~ Interface, adjust = "bonferroni")
```

SUS
```{r}
#SUS
# Run ART model
m.art.avg <- art(sus_score ~ Interface + Error(ParticipantID), data = data)

data %>%
    group_by(Interface) %>%
    summarise(
        mean_sus = mean(sus_score, na.rm = TRUE),
        sd_sus = sd(sus_score, na.rm = TRUE),
        n = n(),
        se = sd_sus / sqrt(n),
        ci_lower = mean_sus - qt(0.975, df = n - 1) * se,
        ci_upper = mean_sus + qt(0.975, df = n - 1) * se
    ) %>%
    print()

# ANOVA
anova_results <- anova(m.art.avg)
print(anova_results)

# Effect sizes (partial eta squared)
eta_squared_results <- eta_squared(anova_results, partial = TRUE)
print(format(eta_squared_results, digits=4))

# Contrasts
art.con(m.art.avg, ~ Interface, adjust = "bonferroni")
```
